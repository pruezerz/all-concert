<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Gateway - ALL CONCERT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgb(100, 20, 20);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .container {
            background: rgb(80, 15, 15);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: rgb(120, 25, 25);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(20px, 5vw, 28px);
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: clamp(12px, 3vw, 14px);
        }

        .content {
            padding: clamp(20px, 5vw, 30px);
        }

        .payment-info {
            background: rgb(60, 10, 10);
            border-radius: 10px;
            padding: clamp(15px, 4vw, 20px);
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 10px;
            flex-wrap: wrap;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: clamp(12px, 3vw, 14px);
            min-width: 120px;
        }

        .info-value {
            font-weight: 600;
            color: white;
            text-align: right;
            font-size: clamp(12px, 3vw, 14px);
            word-break: break-word;
            flex: 1;
        }

        .total-section {
            background: linear-gradient(135deg, rgb(120, 25, 25) 0%, rgb(140, 30, 30) 100%);
            color: white;
            border-radius: 10px;
            padding: clamp(15px, 4vw, 20px);
            margin: 20px 0;
            text-align: center;
        }

        .total-label {
            font-size: clamp(14px, 3.5vw, 16px);
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-amount {
            font-size: clamp(28px, 8vw, 36px);
            font-weight: bold;
            color: rgb(100, 255, 100);
        }

        .payment-methods {
            margin: 20px 0;
        }

        .payment-methods h3 {
            font-size: clamp(14px, 3.5vw, 16px);
            margin-bottom: 15px;
            color: white;
        }

        .method-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .method-btn {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: clamp(10px, 3vw, 15px);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgb(60, 10, 10);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .method-btn:hover {
            border-color: rgb(255, 100, 100);
            background: rgb(80, 15, 15);
            transform: translateY(-2px);
        }

        .method-btn.active {
            border-color: rgb(255, 100, 100);
            background: rgb(80, 15, 15);
        }

        .method-btn .icon {
            font-size: clamp(20px, 5vw, 24px);
            margin-bottom: 5px;
        }

        .method-btn .label {
            font-size: clamp(10px, 2.5vw, 12px);
            color: rgba(255, 255, 255, 0.8);
        }

        .pay-button {
            width: 100%;
            padding: clamp(15px, 4vw, 18px);
            background: linear-gradient(135deg, rgb(255, 200, 50) 0%, rgb(255, 150, 0) 100%);
            color: rgb(60, 10, 10);
            border: none;
            border-radius: 10px;
            font-size: clamp(16px, 4vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 200, 50, 0.4);
        }

        .pay-button:active {
            transform: translateY(0);
        }

        .pay-button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .cancel-button {
            width: 100%;
            padding: clamp(12px, 3.5vw, 15px);
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: clamp(14px, 3.5vw, 16px);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .cancel-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid rgb(255, 200, 50);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .loading p {
            color: white;
            font-size: clamp(14px, 3.5vw, 16px);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            display: none;
            text-align: center;
            padding: clamp(30px, 8vw, 40px);
        }

        .success-icon {
            font-size: clamp(48px, 12vw, 64px);
            color: rgb(100, 255, 100);
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: rgb(100, 255, 100);
            margin-bottom: 10px;
            font-size: clamp(20px, 5vw, 24px);
        }

        .success-message p {
            color: rgba(255, 255, 255, 0.8);
            font-size: clamp(14px, 3.5vw, 16px);
            line-height: 1.6;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 10px;
            }

            .method-options {
                grid-template-columns: repeat(3, 1fr);
            }

            .info-row {
                flex-direction: column;
                gap: 5px;
            }

            .info-value {
                text-align: left;
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ ALL CONCERT</h1>
            <p>Secure Payment Gateway</p>
        </div>

        <div class="content" id="paymentForm">
            <div class="payment-info">
                <div class="info-row">
                    <span class="info-label">Booking Reference</span>
                    <span class="info-value" id="bookingRef">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Concert</span>
                    <span class="info-value" id="concertName">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Artist</span>
                    <span class="info-value" id="artistName">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date</span>
                    <span class="info-value" id="concertDate">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Venue</span>
                    <span class="info-value" id="concertVenue">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Zone</span>
                    <span class="info-value" id="zone">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Seats</span>
                    <span class="info-value" id="seats">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Quantity</span>
                    <span class="info-value" id="quantity">-</span>
                </div>
            </div>

            <div class="total-section">
                <div class="total-label">Total Amount</div>
                <div class="total-amount" id="totalAmount">‡∏ø0.00</div>
            </div>

            <div class="payment-methods">
                <h3>Select Payment Method</h3>
                <div class="method-options">
                    <div class="method-btn active" data-method="credit">
                        <div class="icon">üí≥</div>
                        <div class="label">Credit Card</div>
                    </div>
                    <div class="method-btn" data-method="bank">
                        <div class="icon">üè¶</div>
                        <div class="label">Bank Transfer</div>
                    </div>
                    <div class="method-btn" data-method="mobile">
                        <div class="icon">üì±</div>
                        <div class="label">Mobile Banking</div>
                    </div>
                </div>
            </div>

            <button class="pay-button" id="payButton">PAY NOW</button>
            <button class="cancel-button" id="cancelButton">Cancel</button>
        </div>

        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Processing payment...</p>
        </div>

        <div class="success-message" id="successSection">
            <div class="success-icon">‚úÖ</div>
            <h2>Payment Successful!</h2>
            <p>Your booking has been confirmed.</p>
            <p style="margin-top: 20px;">Please return to the application<br>and click "Check Payment Status"</p>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rmzrcpkrjxntgetjwbqr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtenJjcGtyanhudGdldGp3YnFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MjU3MzUsImV4cCI6MjA3OTQwMTczNX0.4GrzN8TYRAsAP5y7u4wMRI_wHX_1hXCom_Zv6oS5ol8';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bookingRef = urlParams.get('ref') || 'N/A';
        const userId = urlParams.get('userId') || '';
        const concertId = urlParams.get('concertId') || '';
        const concertName = urlParams.get('concert') || 'N/A';
        const artist = urlParams.get('artist') || 'N/A';
        const date = urlParams.get('date') || 'N/A';
        const venue = urlParams.get('venue') || 'N/A';
        const zone = urlParams.get('zone') || 'N/A';
        const seats = urlParams.get('seats') || 'N/A';
        const quantity = urlParams.get('qty') || '0';
        const totalAmount = urlParams.get('amount') || '0.00';

        // Display payment information
        document.getElementById('bookingRef').textContent = bookingRef;
        document.getElementById('concertName').textContent = decodeURIComponent(concertName);
        document.getElementById('artistName').textContent = decodeURIComponent(artist);
        document.getElementById('concertDate').textContent = date;
        document.getElementById('concertVenue').textContent = decodeURIComponent(venue);
        document.getElementById('zone').textContent = zone;
        document.getElementById('seats').textContent = decodeURIComponent(seats);
        document.getElementById('quantity').textContent = quantity + ' seat(s)';
        document.getElementById('totalAmount').textContent = '‡∏ø' + parseFloat(totalAmount).toFixed(2);

        // Payment method selection
        let selectedMethod = 'credit';
        const methodButtons = document.querySelectorAll('.method-btn');
        
        methodButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                methodButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedMethod = this.dataset.method;
            });
        });

        // Pay button
        document.getElementById('payButton').addEventListener('click', async function() {
            // Validate required data
            if (!userId || !concertId || !seats || seats === 'N/A') {
                alert('Missing booking information. Please try again from the application.');
                return;
            }

            // Hide form, show loading
            document.getElementById('paymentForm').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            // Simulate payment processing (2 seconds)
            setTimeout(async () => {
                try {
                    // Create booking in Supabase
                    const bookingData = {
                        user_id: parseInt(userId),
                        concert_id: parseInt(concertId),
                        seat_numbers: decodeURIComponent(seats),
                        quantity: parseInt(quantity),
                        total_price: parseFloat(totalAmount),
                        booking_reference: bookingRef,
                        payment_method: selectedMethod,
                        payment_status: 'PAID',
                        booking_date: new Date().toISOString()
                    };

                    const response = await fetch(SUPABASE_URL + '/rest/v1/bookings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_KEY,
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(bookingData)
                    });

                    if (response.ok) {
                        // Success - store status in localStorage for Java app to check
                        localStorage.setItem('payment_' + bookingRef, 'PAID');
                        
                        // Show success message
                        document.getElementById('loadingSection').style.display = 'none';
                        document.getElementById('successSection').style.display = 'block';
                    } else {
                        const error = await response.text();
                        throw new Error('Booking failed: ' + error);
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    alert('Payment failed: ' + error.message + '\n\nPlease try again or contact support.');
                    
                    // Show form again
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('paymentForm').style.display = 'block';
                }
            }, 2000);
        });

        // Cancel button
        document.getElementById('cancelButton').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this payment?')) {
                localStorage.setItem('payment_' + bookingRef, 'CANCELLED');
                window.close();
            }
        });
    </script>
</body>
</html>
